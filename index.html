<!DOCTYPE html>
<html>

<head>
  <title>Publish Subscribe Tutorial</title>
</head>

<body>
  <div id="alice">
    <p>Alice</p>
    <textarea name="message" rows="8" cols="80"></textarea>
    <input class="publish-button" type="submit" data-author="alice" data-recipient="bob" value="Click here to publish as Alice" />
    <div class="messages"></div>
  </div>
  <div id="bob">
    <p>Bob</p>
    <textarea name="message" rows="8" cols="80"></textarea>
    <input class="publish-button" type="submit" data-author="bob" data-recipient="alice" value="Click here to publish as Bob" />
    <div class="messages"></div>
  </div>
</body>

<script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.21.7.min.js"></script>
<script>
  const getAgentInputElement = (agent) => {
    return document.querySelector(`#${agent} .messages`);
  }

  const appendMessage = (agent, text, messageClass) => {
    let pElement = document.createElement('p');
    pElement.classList.add(messageClass);
    pElement.appendChild(document.createTextNode(text));

    const outputElement = getAgentInputElement(agent);
    outputElement.appendChild(pElement);
  };

  const setupButton = (button, pubnub, messagingChannel) => {
    button.addEventListener('click', ({ target: { dataset: { author, recipient} } }) => {
      const inputElement = document.querySelector(`#${author} textarea`);
      const text = inputElement.value;
      const message = { author, recipient, text };
      appendMessage(author, text, "sent");
      pubnub.publish({
        channel: messagingChannel,
        message
      }, function(status, response) {
        //Handle error here
      });
    });
  }

  const setupPubnub = (pubnub) => {
    pubnub.subscribe({
      channels: [messagingChannel]
    });

    pubnub.addListener({
      message: function({ message: { author, recipient, text }}) {
        appendMessage(recipient, text, "received");
      }
    });
  }

  const pubnub = new PubNub({
    publishKey: "YOUR_PUBLISH_KEY",
    subscribeKey: "YOUR_SUBSCRIBE_KEY"
  });

  const messagingChannel = "messaging_channel";

  const buttons = document.getElementsByClassName('publish-button');
  let index;

  for (index = 0; index < buttons.length; index++) {
    let button = buttons[index];
    setupButton(button, pubnub, messagingChannel);
  }
  setupPubnub(pubnub);
</script></html>
